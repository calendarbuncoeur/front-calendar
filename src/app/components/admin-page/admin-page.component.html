<!-- Affiche un loader pendant la vérification initiale de l'authentification -->
@if (isAuthenticating()) {
<div class="p-4 flex items-center justify-center min-h-[calc(100vh-200px)]">
  <mat-spinner [diameter]="60"></mat-spinner>
</div>
}

<!-- Affiche le formulaire de mot de passe si non authentifié -->
@if (!isAuthenticating() && !isAuthenticated()) {
<div class="p-4 flex items-center justify-center min-h-[calc(100vh-200px)]">
  <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-6 sm:p-8">
    <h1 class="text-2xl font-bold mb-6 text-center">Accès administrateur</h1>
    <form (ngSubmit)="login()">
      <div class="mb-4">
        <mat-form-field class="w-full" appearance="fill">
          <mat-label>Mot de passe</mat-label>
          <input
            matInput
            type="password"
            [ngModel]="password()"
            (ngModelChange)="password.set($event)"
            name="password"
            required
          />
        </mat-form-field>
      </div>

      <button type="submit" mat-raised-button color="primary" [disabled]="isLoading()" class="w-full">
        @if (isLoading()) {
        <mat-spinner [diameter]="24" class="inline-block"></mat-spinner>
        } @else {
        <span>Valider</span>
        }
      </button>

      @if (errorMessage()) {
      <p class="mt-4 text-center text-red-500 font-semibold">{{ errorMessage() }}</p>
      }
    </form>
  </div>
</div>
}

<!-- Affiche la liste des événements si authentifié -->
@if (!isAuthenticating() && isAuthenticated()) {
<div class="w-full max-w-5xl mx-auto p-4">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Tableau de bord</h1>
    <button mat-raised-button color="primary" (click)="openEventDialog()">
      <mat-icon>add</mat-icon>
      <span>Créer un événement</span>
    </button>
  </div>

  <mat-accordion multi>
    @for (event of events(); track event.id) {
    <mat-expansion-panel class="mb-4 shadow-lg rounded-xl">
      <mat-expansion-panel-header collapsedHeight="80px" expandedHeight="80px">
        <mat-panel-title class="flex justify-between items-center w-full">
          <div class="flex flex-col">
            <h2 class="text-xl font-semibold text-blue-600">{{ event.name }}</h2>
            <p class="text-sm text-gray-500">
              {{ event.start_date | date : 'd MMMM y' : '' : 'fr' }}
            </p>
          </div>
          <div class="text-right">
            <span class="font-bold text-lg">{{ event.registrations.length }}</span>
            <span class="text-sm text-gray-600"> inscrits</span>
            <p class="text-xs text-gray-500">
              ({{ event.available_slots }} places restantes)
            </p>
          </div>
        </mat-panel-title>
        <mat-panel-description class="flex-grow-0 flex items-center">
          <button mat-icon-button (click)="openEventDialog(event); $event.stopPropagation();">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="warn" (click)="deleteEvent(event.uuid); $event.stopPropagation();">
            <mat-icon>delete</mat-icon>
          </button>
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="overflow-x-auto">
        @if (event.registrations && event.registrations.length > 0) {
        <table mat-table [dataSource]="event.registrations" class="w-full">
          <!-- Colonnes -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Nom</th>
            <td mat-cell *matCellDef="let reg">{{reg.first_name}} {{reg.last_name}}</td>
          </ng-container>
          <ng-container matColumnDef="contact">
            <th mat-header-cell *matHeaderCellDef>Contact</th>
            <td mat-cell *matCellDef="let reg">{{reg.email || reg.phone_number}}</td>
          </ng-container>
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>Date d'inscription</th>
            <td mat-cell *matCellDef="let reg">{{reg.created_at | date:'dd/MM/yy HH:mm':'':'fr'}}</td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let reg">
              <button mat-icon-button color="warn" (click)="deleteRegistration(reg.id, event.uuid)">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['name', 'contact', 'date', 'actions']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['name', 'contact', 'date', 'actions'];"></tr>
        </table>
        } @else {
        <p class="text-center p-4 text-gray-500">Aucun inscrit pour cet événement.</p>
        }
      </div>
    </mat-expansion-panel>
    }
  </mat-accordion>
</div>
}
